== CREAR USUARIOS Y ROLES ==
-- Crear usuario PRY2205_USER1 --
CREATE USER PRY2205_USER1 IDENTIFIED BY "password"
    DEFAULT TABLESPACE USERS
    TEMPORARY TABLESPACE TEMP
    QUOTA 50M ON USERS;

GRANT CONNECT, RESOURCE TO PRY2205_USER1;
GRANT CREATE TABLE, CREATE INDEX, CREATE VIEW, CREATE SYNONYM TO PRY2205_USER1;

-- Crear usuario PRY2205_USER2 --
CREATE USER PRY2205_USER2 IDENTIFIED BY "password"
    DEFAULT TABLESPACE USERS
    TEMPORARY TABLESPACE TEMP
    QUOTA 10M ON USERS;

GRANT CONNECT TO PRY2205_USER2;
GRANT CREATE VIEW TO PRY2205_USER2;

-- Crear rol PRY2205_ROL_D --
CREATE ROLE PRY2205_ROL_D;
GRANT SELECT ON PRY2205_USER1.PACIENTE TO PRY2205_ROL_D;
GRANT SELECT ON PRY2205_USER1.PAGOS TO PRY2205_ROL_D;

GRANT PRY2205_ROL_D TO PRY2205_USER2;

-- PRY2205_USER1 --
CREATE PUBLIC SYNONYM SYN_PACIENTE FOR PRY2205_USER1.PACIENTE;
CREATE PUBLIC SYNONYM SYN_PAGOS FOR PRY2205_USER1.PAGOS;

-- PRY2205_USER2 --
CREATE SYNONYM SYN_PACIENTE FOR PRY2205_USER1.PACIENTE;
CREATE SYNONYM SYN_PAGOS FOR PRY2205_USER1.PAGOS;

== CASO 2 V_RECALCULO_PAGOS ==
CREATE OR REPLACE VIEW V_RECALCULO_PAGOS AS
SELECT 
    TO_CHAR(pac.pac_run, '99G999G999') || '-' || pac.dv_run AS RUT,
    INITCAP(pac.pnombre) AS Nombre,
    INITCAP(pac.apaterno) AS Apellido,
    TO_CHAR(pag.monto_consulta, 'L99G999') AS "Monto Original",
    CASE 
        WHEN pag.monto_consulta BETWEEN 15000 AND 25000 THEN TO_CHAR(ROUND(pag.monto_consulta * 1.15, 0), 'L99G999')
        WHEN pag.monto_consulta > 25000 THEN TO_CHAR(ROUND(pag.monto_consulta * 1.20, 0), 'L99G999')
        ELSE TO_CHAR(pag.monto_consulta, 'L99G999')
    END AS "Monto Reajustado",
    EXTRACT(YEAR FROM SYSDATE) - EXTRACT(YEAR FROM pac.fecha_nacimiento) AS Edad
FROM SYN_PAGOS pag
LEFT JOIN BONO_CONSULTA bon ON pag.id_bono = bon.id_bono
LEFT JOIN SYN_PACIENTE pac ON bon.pac_run = pac.pac_run
WHERE TO_DATE(bon.hr_consulta, 'HH24:MI') > TO_DATE('17:15', 'HH24:MI')
ORDER BY RUT, "Monto Reajustado";

== CASO3 VISTA_AUM_MEDICO_X_CARGO ==
CREATE OR REPLACE VIEW VISTA_AUM_MEDICO_X_CARGO AS
SELECT 
    TO_CHAR(med.rut_med, '99G999G999') || '-' || med.dv_run AS RUT,
    cargo.nombre AS Cargo,
    TO_CHAR(med.sueldo_base, 'L99G999') AS "Sueldo Base",
    TO_CHAR(ROUND(med.sueldo_base * 1.15, 0), 'L99G999') AS "Sueldo Aumentado"
FROM MEDICO med
LEFT JOIN CARGO cargo ON med.car_id = cargo.car_id
WHERE LOWER(cargo.nombre) LIKE '%atenci√≥n%'
ORDER BY "Sueldo Aumentado";

== INDEXES ==
CREATE INDEX IDX_PACIENTE_RUN ON PRY2205_USER1.PACIENTE(pac_run);
CREATE INDEX IDX_PAGOS_MONTO ON PRY2205_USER1.PAGOS(monto_consulta);
CREATE INDEX IDX_MEDICO_CARGO ON PRY2205_USER1.MEDICO(rut_med, car_id);